# mbed OS 5.0 core port

The key components of mbed OS 5.0 are the same as previous versions of mbed OS. However, due to improvements to the build system and code layout, some components need to be refactored before they can be used in mbed OS 5.0. Significantly, the MINAR scheduler is replaced with RTX (an RTOS). Ports of RTX already exist for a wide range of hardware, and these can be used in mbed OS 5.0 as per the instructions below. Components like uVisor and mbed TLS have updates, and the way they are integrated differs.

Adding a target to mbed OS 5.0 requires one or more of the following steps:

1. [Adding a new target](#adding-a-new-target-to-mbedmicro/mbed) to the ARMmbed/mbed repository (equivalent to a yotta target).
2. [Adding RTX support](#adding-rtx-support) (RTX replaces MINAR).
3. [Adjusting code from mbed OS 3.0 to mbed OS 5.0.](#adjusting-code-from-mbed-os-30-to-mbed-os-50)
4. Executing mbed OS 5.0 test suites.

## Adding a new target

If you have already completed an mbed OS port (either 2 or 3.0), then much of the work in porting is already done - mbed OS 5.0, mbed OS 3.0 and mbed OS 2 are very closely related.

## Adding RTX support

This is a required step for mbed OS 5.0 as the RTOS becomes a vital part of our software framework.

A target must define the RTOS configuration. We currently have two supported implementations of RTX - for the Cortex-A and the Cortex-M. They share some code, but there are differences. This document describes The Cortex-M version of RTX (currently v4.79 of RTX). The sources can be found [here](https://github.com/mbedmicro/mbed/tree/master/rtos/rtx/TARGET_CORTEX_M).

The following macros must be defined:

- In [``rtos\rtx\TARGET_CORTEX_M\RTX_CM_lib.h``](https://github.com/mbedmicro/mbed/blob/master/rtos/rtx/TARGET_CORTEX_M/RTX_CM_lib.h):
	- `INITIAL_SP`: initial stack pointer.
- In [``rtos\rtx\TARGET_CORTEX_M\RTX_Conf_CM.c``](https://github.com/mbedmicro/mbed/blob/master/rtos/rtx/TARGET_CORTEX_M/RTX_Conf_CM.c):
	- `OS_CLOCK` - kernel timer input clock frequency.
	- `OS_MAINSTKSIZE` - main thread stack size.
	- `OS_TASKCNT` - max number of concurrent running threads.


By default, CMSIS-RTOS uses the ARM SysTick Timer. If the MCU doesn't contain SysTick Timer, use the tick timer API. For more information, visit [CMSIS-RTOS RTX Timer Tick](https://www.keil.com/pack/doc/CMSIS/RTX/html/_timer_tick.html).

## Adjusting code from mbed OS 3.0 to mbed OS 5.0

The mbed OS 5.0 ``hal/targets`` folder contains two subfolders: **cmsis** and **hal**. In each directory, there are target dependencies described as ``TARGET_xx`` (where xx is the name of a vendor, the target and the MCU family name).

To port a target from mbed OS 3.0, consolidate the two core modules ``cmsis-core`` and ``mbed-hal`` with their target dependencies to mbed OS 5.0. 

For example,``cmsis-core -> cmsis-core-vendor -> cmsis-core-mcu-family`` would transform to ``hal/targets/cmsis/TARGET_VENDOR/TARGET_MCU_FAMILY``.

For more information, see the [CMSIS-CORE](CMSIS_CORE.md) and [HAL](HAL.md) pages.

## Migration from mbed OS 3.0 to mbed OS 5.0

Changes between the mbed OS 3.0 and mbed OS 5.0 HAL:

1. [Low Power Ticker API](#low-power-ticker-api).
2. [HAL init API](#init-hal-api).
3. [Sleep API](#sleep-api).
4. [PinNames definitions](#pinnames-definitions).

### hal/targets/cmsis

There are no API changes in the cmsis-core.

### hal/targets/hal

#### Low Power Ticker API

The low power ticker in mbed OS 5.0 is nearly identical to the `us_ticker` API from mbed OS 3.0, as it provides the same functionality.

Three functions from mbed OS 3.0 are not defined, because MINAR had different requirements::

- ``lp_ticker_get_overflows_counter``
- ``lp_ticker_get_compare_match``
- ``lp_ticker_sleep_until``

The low power ticker API is defined in [``lp_ticker_api.h``](https://github.com/mbedmicro/mbed/blob/master/hal/hal/lp_ticker_api.h).

#### Init HAL API

The ``mbed_hal_init`` function should be renamed to ``mbed_sdk_init``. It's often placed in the ``mbed_overrides.c`` file, as it has weak linkage (so it might be overwritten by an application).

#### Sleep API

``mbed_enter_sleep`` and ``mbed_exit_sleep`` are not defined in mbed OS 5.0.

The sleep API declares two other functions: ``sleep`` and ``deep_sleep``.

The sleep API is defined in [``sleep_api.h``](https://github.com/mbedmicro/mbed/blob/master/hal/hal/sleep_api.h).

#### PinNames definitions

In mbed OS 3.0, pin names were generated by yotta and scripts. In 5.0, the file ``mbed-hal/chip_pins.array`` needs to become ``PinNames.h``:

```
// An example of PinName for a target
typedef enum {
    /* Serial */
    SERIAL_TX   = PD7,
    SERIAL_RX   = PD6,
    USBTX       = PD4,
    USBRX       = PD5,
    EFM_BC_EN   = PA9,

    /* Not connected */
    NC = (int) 0xFFFFFFFF
} PinName;

```

For instance, the MBED LPC1768 PinNames header file can be found [here](https://github.com/mbedmicro/mbed/blob/master/hal/targets/hal/TARGET_NXP/TARGET_LPC176X/TARGET_MBED_LPC1768/PinNames.h).
